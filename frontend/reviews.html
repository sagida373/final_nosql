<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airbnb • Reviews</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand" href="index.html">Airbnb</a>
    <div class="navbar-nav">
      <a class="nav-link" href="index.html">Listings</a>
      <a class="nav-link" href="search.html">Search</a>
      <a class="nav-link" href="availability.html">Availability</a>
      <a class="nav-link" href="host.html">Host</a>
      <a class="nav-link active" href="reviews.html">Reviews</a>
      <a class="nav-link" href="admin.html">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h1 class="h4">Reviews</h1>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">listing_id</label>
          <input id="listing_id" class="form-control" placeholder="e.g. 10000073">
        </div>
        <div class="col-md-2">
          <label class="form-label">limit</label>
          <input id="limit" class="form-control" type="number" min="1" value="20">
        </div>
        <div class="col-md-2">
          <button id="btnLoad" class="btn btn-primary w-100">Load</button>
        </div>
      </div>
    </div>
  </div>

  <div id="status" class="text-muted mb-3"></div>

  <div class="row g-3">
    <!-- STATS -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6">Stats</h2>
          <div id="stats" class="small text-muted">—</div>
        </div>
      </div>
    </div>

    <!-- ADD REVIEW -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6">Add review</h2>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">review_id</label>
              <input id="new_review_id" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">reviewer_id</label>
              <input id="new_reviewer_id" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">reviewer_name</label>
              <input id="new_reviewer_name" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">rating (1–5)</label>
              <input id="new_rating" class="form-control" type="number" min="1" max="5">
            </div>
            <div class="col-12">
              <label class="form-label">comments</label>
              <textarea id="new_comments" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12 d-flex gap-2">
              <button id="btnAdd" class="btn btn-success">Add</button>
              <div id="addMsg" class="small text-muted align-self-center"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REVIEWS LIST -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6">Reviews list</h2>

          <div class="col-md-4 mb-3">
            <label class="form-label">Admin token</label>
            <input id="admin_token" class="form-control" placeholder="dev-admin-token">
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>_id</th>
                  <th>name</th>
                  <th>rating</th>
                  <th>verified</th>
                  <th>comments</th>
                  <th style="width:220px">actions</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";

function adminHeaders() {
  return {
    "Content-Type": "application/json",
    "X-Admin-Token": document.getElementById("admin_token").value.trim()
  };
}

async function fetchJSON(url, opts) {
  const res = await fetch(url, opts);
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
  return text ? JSON.parse(text) : null;
}

function getListingId() {
  return document.getElementById("listing_id").value.trim();
}

async function loadReviews() {
  const listingId = getListingId();
  const limit = document.getElementById("limit").value || 20;
  const rows = document.getElementById("rows");
  const status = document.getElementById("status");
  const statsBox = document.getElementById("stats");

  if (!listingId) {
    status.textContent = "Enter listing_id";
    return;
  }

  status.textContent = "Loading...";
  rows.innerHTML = "";
  statsBox.textContent = "Loading stats...";

  /* REVIEWS */
  const reviews = await fetchJSON(
    `${API}/api/listings/${encodeURIComponent(listingId)}/reviews?limit=${limit}`
  );

  rows.innerHTML = reviews.map(r => {
    const rid = r._id || r.review_id;
    return `
      <tr>
        <td><code>${rid}</code></td>
        <td>${r.reviewer_name ?? ""}</td>
        <td><input class="form-control form-control-sm" type="number" min="1" max="5" value="${r.rating ?? ""}"></td>
        <td>
          <select class="form-select form-select-sm">
            <option value="true" ${r.verified ? "selected" : ""}>true</option>
            <option value="false" ${!r.verified ? "selected" : ""}>false</option>
          </select>
        </td>
        <td><textarea class="form-control form-control-sm" rows="1">${r.comments ?? ""}</textarea></td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="doPatch('${rid}', this)">Save</button>
          <button class="btn btn-sm btn-outline-danger" onclick="doDelete('${rid}')">Delete</button>
        </td>
      </tr>`;
  }).join("");

  /* STATS */
  try {
    const stats = await fetchJSON(
      `${API}/api/listings/${encodeURIComponent(listingId)}/reviews/stats`
    );

    const d = stats.rating_distribution || {};

    statsBox.innerHTML = `
      <div><b>Total ratings:</b> ${stats.count}</div>
      <div><b>Average:</b> ${stats.average_rating ?? "-"}</div>
      <div><b>Min:</b> ${stats.min_rating ?? "-"}</div>
      <div><b>Max:</b> ${stats.max_rating ?? "-"}</div>
      <div class="mt-2 small">
        1: ${d[1] ?? 0},
        2: ${d[2] ?? 0},
        3: ${d[3] ?? 0},
        4: ${d[4] ?? 0},
        5: ${d[5] ?? 0}
      </div>
    `;
  } catch (e) {
    statsBox.textContent = "No stats available";
  }

  status.textContent = `Loaded: ${reviews.length}`;
}

async function doAdd() {
  const listingId = getListingId();
  const msg = document.getElementById("addMsg");

  const body = {
    reviewer_id: new_reviewer_id.value,
    reviewer_name: new_reviewer_name.value,
    comments: new_comments.value,
    verified: true
  };

  if (new_rating.value) body.rating = Number(new_rating.value);

  await fetchJSON(
    `${API}/api/listings/${listingId}/reviews/${new_review_id.value}`,
    {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    }
  );

  msg.textContent = "Added ✅";
  loadReviews();
}

async function doPatch(reviewId, btn) {
  const tr = btn.closest("tr");
  const inputs = tr.querySelectorAll("input, select, textarea");

  const body = {
    verified: inputs[1].value === "true",
    comments: inputs[2].value
  };
  if (inputs[0].value) body.rating = Number(inputs[0].value);

  await fetchJSON(
    `${API}/api/admin/listings/${getListingId()}/reviews/${reviewId}`,
    {
      method: "PATCH",
      headers: adminHeaders(),
      body: JSON.stringify(body)
    }
  );

  btn.textContent = "Saved ✅";
  setTimeout(() => btn.textContent = "Save", 800);
}

async function doDelete(reviewId) {
  if (!confirm("Delete this review?")) return;

  await fetchJSON(
    `${API}/api/admin/listings/${getListingId()}/reviews/${reviewId}`,
    {
      method: "DELETE",
      headers: adminHeaders()
    }
  );

  loadReviews();
}

btnLoad.onclick = loadReviews;
btnAdd.onclick = doAdd;
</script>
</body>
</html>
