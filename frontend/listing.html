<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airbnb • Listing</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand" href="index.html">Airbnb</a>
    <div class="navbar-nav">
      <a class="nav-link" href="index.html">Listings</a>
      <a class="nav-link" href="search.html">Search</a>
      <a class="nav-link" href="availability.html">Availability</a>
      <a class="nav-link" href="host.html">Host</a>
      <a class="nav-link" href="reviews.html">Reviews</a>
      <a class="nav-link" href="admin.html">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between">
    <h1 class="h4 mb-0">Listing</h1>
    <a class="btn btn-outline-secondary btn-sm" href="index.html">Back</a>
  </div>

  <div id="status" class="text-muted my-3"></div>

  <div id="card" class="card shadow-sm d-none">
    <div class="card-body">
      <h2 id="name" class="h5"></h2>
      <div id="meta" class="text-muted small mb-3"></div>
      <div id="price" class="mb-3"></div>

      <div class="d-flex gap-2">
        <a id="reviewsLink" class="btn btn-sm btn-primary" href="#">Manage reviews</a>
      </div>

      <hr class="my-4"/>
      <h3 class="h6">Last 5 reviews (from listing document)</h3>
      <div id="reviews" class="small"></div>
    </div>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";

function qs(name) {
  return new URLSearchParams(location.search).get(name);
}
async function fetchJSON(url, opts) {
  const res = await fetch(url, opts);
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
  return text ? JSON.parse(text) : null;
}

async function load() {
  const id = qs("id");
  const status = document.getElementById("status");
  const card = document.getElementById("card");
  if (!id) { status.textContent = "No id in URL"; return; }

  status.textContent = "Loading...";
  try {
    const doc = await fetchJSON(`${API}/api/listings/by-id/${encodeURIComponent(id)}`);

    document.getElementById("name").textContent = doc.name ?? "No name";
    const market = doc.address?.market ?? "-";
    const country = doc.address?.country ?? "";
    document.getElementById("meta").textContent =
      `${market}${country ? " • " + country : ""} • ${doc.room_type ?? "-"}`;

    document.getElementById("price").innerHTML = `<b>Price:</b> ${doc.price ?? "-"}`;
    document.getElementById("reviewsLink").href = `reviews.html?listing_id=${encodeURIComponent(doc._id)}`;

    const reviews = Array.isArray(doc.reviews) ? doc.reviews : [];
    document.getElementById("reviews").innerHTML = reviews.length
      ? `<ul class="mb-0">${reviews.map(r => `
          <li><b>${r.reviewer_name ?? "?"}</b>: ${r.comments ?? ""}</li>
        `).join("")}</ul>`
      : `<div class="text-muted">No reviews in this listing doc slice.</div>`;

    card.classList.remove("d-none");
    status.textContent = `Loaded listing: ${doc._id}`;
  } catch (e) {
    console.error(e);
    status.textContent = `Error: ${e.message}`;
  }
}
load();
</script>
</body>
</html>
